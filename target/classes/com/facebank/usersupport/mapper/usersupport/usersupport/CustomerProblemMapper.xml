<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.facebank.usersupport.mapper.usersupport.usersupport.CustomerProblemMapper">
    <resultMap id="BaseResultMap" type="com.facebank.usersupport.model.CustomerProblemModel">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="service_id" jdbcType="BIGINT" property="serviceId"/>
        <result column="type_id" jdbcType="BIGINT" property="typeId"/>
        <result column="title" jdbcType="VARCHAR" property="title"/>
        <result column="gmt_create" jdbcType="BIGINT" property="gmtCreate"/>
        <result column="gmt_modified" jdbcType="BIGINT" property="gmtModified"/>
        <result column="note" jdbcType="VARCHAR" property="note"/>
        <result column="status" jdbcType="BIT" property="status"/>
    </resultMap>
    <resultMap id="ResultMap" type="com.facebank.usersupport.dto.CustomerProblemDto">
        <id column="problem_id" jdbcType="BIGINT" property="id"/>
        <result column="type_id" jdbcType="BIGINT" property="typeId"/>
        <result column="title" jdbcType="VARCHAR" property="title"/>
        <!-- 多对一的关系 -->
        <!-- property: 指的是属性的值, javaType：指的是属性的类型-->
        <association property="customerServiceDto" javaType="com.facebank.usersupport.dto.CustomerServiceDto">
            <id column="service_id" jdbcType="BIGINT" property="id"/>
            <result column="phone_number" jdbcType="VARCHAR" property="phoneNumber"/>
            <result column="name" jdbcType="VARCHAR" property="name"/>
            <result column="ctype_id" jdbcType="INTEGER" property="typeId"/>
            <result column="username" jdbcType="VARCHAR" property="username"/>
            <result column="status" jdbcType="INTEGER" property="status"/>
            <result column="phone_type" jdbcType="VARCHAR" property="phoneType"/>
            <result column="phone_type" jdbcType="TINYINT" property="phoneType"/>
        </association>
        <!-- 一对多的关系 -->
        <!-- property: 指的是集合属性的值, ofType：指的是集合中元素的类型 -->
        <collection property="customerPictureModels" ofType="com.facebank.usersupport.dto.CustomerPictureDto">
            <id column="picture_id" jdbcType="BIGINT" property="id"/>
            <result column="pic_url" jdbcType="VARCHAR" property="picUrl"/>
        </collection>
        <collection property="customerProblemDescriptionModels" ofType="com.facebank.usersupport.dto.CustomerDescriptionDto">
            <id column="question_id" jdbcType="BIGINT" property="id"/>
            <result column="description" jdbcType="VARCHAR" property="description"/>
        </collection>
        <collection property="customerProblemSolves" ofType="com.facebank.usersupport.dto.CustomerSolveDto">
            <id column="solve_id" jdbcType="BIGINT" property="id"/>
            <result column="cdescription" jdbcType="VARCHAR" property="description"/>
            <result column="gmt_create" jdbcType="BIGINT" property="gmtCreate"/>
        </collection>
    </resultMap>

    <select id="selectPersonById" resultMap="ResultMap">
    select p.*, o.* from customer_problem_picture p, customer_service_problem o where p.problem_id  = o.id
  </select>
    <sql id="Base_Column_List">
    id, service_id, type_id, title, gmt_create, gmt_modified, note, status
  </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from customer_service_problem
        where id = #{id,jdbcType=BIGINT}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    delete from customer_service_problem
    where id = #{id,jdbcType=BIGINT}
  </delete>
    <insert id="insert" parameterType="com.facebank.usersupport.model.CustomerProblemModel">
    insert into customer_service_problem (id, service_id, type_id,
      title, gmt_create, gmt_modified, 
      note, status)
    values (#{id,jdbcType=BIGINT}, #{serviceId,jdbcType=BIGINT}, #{typeId,jdbcType=BIGINT},
      #{title,jdbcType=VARCHAR}, #{gmtCreate,jdbcType=BIGINT}, #{gmtModified,jdbcType=BIGINT}, 
      #{note,jdbcType=VARCHAR}, #{status,jdbcType=BIT})
  </insert>
    <insert id="insertSelective" parameterType="com.facebank.usersupport.model.CustomerProblemModel">
        <selectKey resultType="java.lang.Long" order="AFTER" keyProperty="id">
            SELECT LAST_INSERT_ID() AS ID
        </selectKey>
        insert into customer_service_problem
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="serviceId != null">
                service_id,
            </if>
            <if test="typeId != null">
                type_id,
            </if>
            <if test="title != null">
                title,
            </if>
            <if test="gmtCreate != null">
                gmt_create,
            </if>
            <if test="gmtModified != null">
                gmt_modified,
            </if>
            <if test="note != null">
                note,
            </if>
            <if test="status != null">
                status,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=BIGINT},
            </if>
            <if test="serviceId != null">
                #{serviceId,jdbcType=BIGINT},
            </if>
            <if test="typeId != null">
                #{typeId,jdbcType=BIGINT},
            </if>
            <if test="title != null">
                #{title,jdbcType=VARCHAR},
            </if>
            <if test="gmtCreate != null">
                #{gmtCreate,jdbcType=BIGINT},
            </if>
            <if test="gmtModified != null">
                #{gmtModified,jdbcType=BIGINT},
            </if>
            <if test="note != null">
                #{note,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                #{status,jdbcType=BIT},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.facebank.usersupport.model.CustomerProblemModel">
        update customer_service_problem
        <set>
            <if test="serviceId != null">
                service_id = #{serviceId,jdbcType=BIGINT},
            </if>
            <if test="typeId != null">
                type_id = #{typeId,jdbcType=BIGINT},
            </if>
            <if test="title != null">
                title = #{title,jdbcType=VARCHAR},
            </if>
            <if test="gmtCreate != null">
                gmt_create = #{gmtCreate,jdbcType=BIGINT},
            </if>
            <if test="gmtModified != null">
                gmt_modified = #{gmtModified,jdbcType=BIGINT},
            </if>
            <if test="note != null">
                note = #{note,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=BIT},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.facebank.usersupport.model.CustomerProblemModel">
    update customer_service_problem
    set service_id = #{serviceId,jdbcType=BIGINT},
      type_id = #{typeId,jdbcType=BIGINT},
      title = #{title,jdbcType=VARCHAR},
      gmt_create = #{gmtCreate,jdbcType=BIGINT},
      gmt_modified = #{gmtModified,jdbcType=BIGINT},
      note = #{note,jdbcType=VARCHAR},
      status = #{status,jdbcType=BIT}
    where id = #{id,jdbcType=BIGINT}
  </update>
    <select id="findProblemById" parameterType="java.lang.Long" resultMap="ResultMap">
SELECT cspic.id picture_id,cspr.id service_id,csp.id problem_id,cspd.id question_id,cps.id solve_id,
        csp.type_id,csp.title,cspr.status,cspr.is_satisfied,cspr.phone_type,
         usr.username,cspr.type_id ctype_id,cspr.phone_number,cspr.name,
       cspic.pic_url,cspd.description,cps.description cdescription,cps.gmt_create
FROM ( customer_service_phone_record AS cspr,customer_service_problem AS csp,customer_service_problem_description AS cspd,customer_problem_solve AS cps,user as usr )LEFT JOIN customer_problem_picture AS cspic ON csp.id=cspic.problem_id
WHERE  cspr.id= #{id} AND csp.service_id=cspr.id AND csp.id = cspd.problem_id AND csp.id=cps.problem_id and
usr.work_number = cspr.worker_number;
</select>


</mapper>