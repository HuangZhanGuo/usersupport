<html xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:include="common/head_info::head_infor"></div>
    <script type="text/javascript" th:src="@{../js/moment-with-locales.min.js}"></script>
    <script type="text/javascript" th:src="@{../js/bootstrap-datetimepicker.js}"></script>
    <script type="text/javascript" th:src="@{../js/bootstrap-datetimepicker.zh-CN.js}"></script>
    <link rel="stylesheet" type="text/css" th:href="@{../css/bootstrap-datetimepicker.css}">

    <form class="form-inline" id="repaymentForm">
        <div class="form-group">
            <label for="userId">用户ID</label>
            <input type="text" class="form-control" id="userId" name="userId" placeholder="用户ID"
                   onkeypress="return event.keyCode>=48&&event.keyCode<=57">
        </div>
        <div class="form-group">
            <label for="orderId">订单ID</label>
            <input type="email" class="form-control" id="orderId" name="orderId" placeholder="订单ID"
                   onkeypress="return event.keyCode>=48&&event.keyCode<=57">
        </div>
        <!--<div class="form-group">
                             <label for="datetimeStart">还款日期</label>
                             <input size="16" type="text" id="datetimeStart" readonly class="form_datetime">
                         </div>-->
        <div class="form-group">
            <label class="labe_l">还款日期:</label>
            <input type="text" class="form_datetime" id="datetimeStart" name="startTime" readonly>
            --
            <input type="text" class="form_datetime" id="datetimeEnd" name="endTime" readonly>

        </div>
        <span class="btn btn-default" onclick="reset()" >重置</span>
        <span class="btn btn-default" onclick="search()" >查询</span>
    </form>

    <script type="text/javascript">
        var page = 1;
        var pageSize = 20;
        var totalCount = 0;
        var totalPage = 0;
        //重置表单
        function reset(){
            $("#repaymentForm")[0].reset();
        }

        // 查询还款信息
        function search(){
            // 将日期格式转换为时间戳
            var dateStart = $("#datetimeStart").val();
            var dateEnd = $("#datetimeEnd").val();
            var startTime = null;
            var endTime = null;
            if(dateStart != null && dateStart != ""){
                startTime = new Date(dateStart).getTime();
            }
            if(dateEnd != null && dateEnd != ""){
                endTime = new Date(dateEnd).getTime();
            }
            // 获取用户输入的userId和orderId
            var userId = $("#userId").val();
            var orderId = $("#orderId").val();

            if((startTime != null && startTime != "") && (endTime != null && endTime != "")){
                var timeInterval = endTime - startTime;
                if(timeInterval > 2592000000){
                    alert("时间间隔不能超过30天");
                    return;
                }else if(timeInterval < 0){
                    alert("结束时间不能小于开始时间");
                    return;
                }
            }
            // 当四个条件都为空时flag==true
            var flag = (userId == null || userId == "") && (orderId == null || orderId == "") && (startTime == null || startTime == "") && (endTime == null || endTime == "");
            if(flag){
                alert("请输入查询条件");
                return;
            }

            $.ajax({
                async : true,
                url : "/service/repayment",
                type : "post",
                data : {userId:userId,orderId:orderId,startTime:startTime,endTime:endTime,page:page,pageSize:pageSize},
                dataType : "json",
                success : function(result) {
                    // 回显userId和orderId
                    $("#userId").val(userId);
                    $("#orderId").val(orderId);
                    // 将分页相关数据保存到全局变量中
                    page = result.data.page;
                    pageSize = result.data.pageSize;
                    totalCount = result.data.totalCount;
                    totalPage = result.data.totalPage;
                    $("#currentPage").val(page);
                    $("#totalCount").html(totalPage);
                    var tbody = window.document.getElementById("repaymentData");
                    var datas=result.data.data;
                    var str="";
                    for (i in datas) {
                        str += "<tr>" + "<td>";
                        if(datas[i].credOrderId != null) {
                            str += datas[i].credOrderId;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].credUserId != null) {
                            str += datas[i].credUserId;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].credPlanPrincipal != null) {
                            str += datas[i].credPlanPrincipal;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].credPlanInterest != null) {
                            str += datas[i].credPlanInterest;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].credPlanDate != null) {
                            str += new Date(parseInt(datas[i].credPlanDate)).toLocaleString().replace(/年|月/g, "-").replace(/日/g, " ");
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].redLocalInfo != null){
                            str += datas[i].redLocalInfo['"model_name"'];
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].redPlanAmount != null) {
                            str += datas[i].redPlanAmount;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].redPackageType == 1000){
                            str += "加息红包";
                        }else if(datas[i].redPackageType == 1010){
                            str += "返现红包";
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].redTermNum != null){
                            str += datas[i].redTermNum;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].vipRate != null){
                            str += datas[i].vipRate;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].vipPlanAmount != null){
                            str += datas[i].vipPlanAmount;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].vipTermNum != null){
                            str += datas[i].vipTermNum;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].pfPlanAmount != null){
                            str += datas[i].pfPlanAmount;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].pfTermNum != null){
                            str += datas[i].pfTermNum;
                        }
                        str += "</td>" + "<td>";
                        if(datas[i].pfType == 100){
                            str += "首购加息";
                        }else if(datas[i].pfType == 200){
                            str += "限时加息";
                        }else if(datas[i].pfType == 300){
                            str += "项目加息";
                        }
                        str += "</td>" + "</tr>";
                        console.log(str);
                    }
                    tbody.innerHTML = str;
                }
            })
        }

        // 跳转到首页
        function toHomePage(){
            if(page != 1 && totalPage != 0){
                page = 1;
                search();
            }
        }

        // 跳转到尾页
        function toEndPage(){
            if(page < totalPage){
                page = totalPage;
                search();
            }
        }

        // 跳转到上一页
        function toPreviousPage(){
            if(totalPage != 0 && page >= 2){
                page = page -1;
                search();
            }
        }

        // 跳转到下一页
        function toNextPage(){
            if(page < totalPage){
                page = page + 1;
                search();
            }
        }

        // 跳转到指定页面
        function toPage(){
            var currentPage = $("#currentPage").val();
            if(totalPage != 0 && currentPage >=1 && currentPage <= totalPage && currentPage != page){
                page = currentPage;
                search();
            }
        }

        //修改每页显示条数
        function changePageSize(){
            var size = $("#pageSize").val();
            pageSize = size;
            search();
        }
    </script>

    <form>
        <div class="row">
            <div class="col-lg-5">
                <div class="panel panel-default" style="width:100%;overflow:auto">
                    <div class="panel-heading">客户信息列表</div>
                    <table class="table table-bordered table-striped" align="center">
                        <thead>
                        <tr>
                            <th>订单ID</th>
                            <th>用户ID</th>
                            <th>债权计划本金</th>
                            <th>计划利息</th>
                            <th>计划时间</th>
                            <th>红包信息</th>
                            <th>红包金额</th>
                            <th>加息红包/返现红包</th>
                            <th>红包期限</th>
                            <th>vip利率</th>
                            <th>vip收益</th>
                            <th>vip期数</th>
                            <th>加息金额</th>
                            <th>加息期数</th>
                            <th>首购加息/限时加息/项目加息</th>
                        </tr>
                        </thead>
                        <tbody id="repaymentData">
                        </tbody>
                    </table>
                    <div class="col-md-12 text-right">
                    </div>
                </div>
            </div>
        </div>
        <div align="center">
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    <li>
                        <a href="javascript:void(0);" aria-label="Previous" onclick="toHomePage()">
                            <span aria-hidden="true">首页</span>
                        </a>
                    </li>
                    <li><a href="javascript:void(0);" onclick="toPreviousPage()">上一页</a></li>
                    <li><a href="javascript:void(0);" onclick="toNextPage()">下一页</a></li>
                    <li>
                        <a href="javascript:void(0);" aria-label="Next" onclick="toEndPage()">
                            <span aria-hidden="true">尾页</span>
                        </a>
                    </li>
                    <span>
                        第<input type="text" style="width: 30px" name="page" id="currentPage"
                                onkeypress="return event.keyCode>=48&&event.keyCode<=57">/<span id="totalCount"></span>页
                    </span>
                    <li>
                        <a href="javascript:void(0);" onclick="toPage()">
                            <span aria-hidden="true">GO</span>
                        </a>
                    </li>
                    <span style="margin-left:10px">
                        每页显示
                        <select id="pageSize" onchange="changePageSize()">
                            <option>20</option>
                            <option>30</option>
                            <option>50</option>
                        </select>
                        条
                    </span>
                </ul>
            </nav>
        </div>
    </form>

    <script type="text/javascript">
        //日期插件初始化
        $('#datetimeStart').datetimepicker({
            language:  'zh-CN',
            // format:'yyyy-mm-dd',
            format:'yyyy-mm-dd hh:ii',
            weekStart: 1, /*以星期一为一星期开始*/
            todayBtn:  1,
            autoclose: 1,
            // minView:2, /*精确到天*/
            todayHighlight: 1,
            startView: 2,
            forceParse: 0,
            showMeridian: 1,
            pickerPosition: "bottom-left"
        }).on("changeDate",function(ev){  //值改变事件
            //选择的日期不能大于第二个日期控件的日期
            if(ev.date){
                $("#datetimeEnd").datetimepicker('setStartDate', new Date(ev.date.valueOf()));
            }else{
                $("#datetimeEnd").datetimepicker('setStartDate',null);
            }
        });
        $('#datetimeEnd').datetimepicker({
            language:  'zh-CN',
            format:'yyyy-mm-dd hh:ii',
            weekStart: 1, /*以星期一为一星期开始*/
            todayBtn:  1,
            autoclose: 1,
            // minView:2, /*精确到天*/
            todayHighlight: 1,
            startView: 2,
            forceParse: 0,
            showMeridian: 1,
            pickerPosition: "bottom-left"
        }).on("changeDate",function(ev){
            /*选择的日期不能小于第一个日期控件的日期*/
            if(ev.date){
                $("#datetimeStart").datetimepicker('setEndDate', new Date(ev.date.valueOf()));
            }else{
                $("#datetimeStart").datetimepicker('setEndDate',new Date());
            }
        });
    </script>

</html>