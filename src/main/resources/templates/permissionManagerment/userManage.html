<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <div th:include="common/head_info::head_infor"></div>
</head>
<body>
<div class="container center" style="margin-top: 20px;">
    <div class="panel panel-default ">
        <!-- Default panel contents -->
        <div class="panel-heading">用户管理</div>

        <!-- Table -->
        <table class="table">
            <thead>
            <tr>
                <th>用户id</th>
                <th>用户名称</th>
                <th>操作角色</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="roleList">
            </tbody>
        </table>
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">×</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">New message</h4>
                    </div>
                    <div class="modal-body">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>授权</th>
                                <th>角色名</th>
                                <th>描述</th>
                            </tr>
                            </thead>
                            <tbody id="permission">
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="updataDate()">修改</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var recipient="";
    $('#exampleModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) // 触发事件的按钮
         recipient = button.data('whatever') // 解析出data-whatever内容
        var ids=new Array();
        $.ajax({
            url: "/role/findAllRole",
            type: "POST",
            dataType: "json",
            success: function (json) {
                var str = ""
                for (var i = 0; i < json.data.length; i++) {
                    str += "<tr class='success'>" +
                        " <td><input type='checkbox' id='"+json.data[i].roleId+"'value='"+json.data[i].roleId+"'></td>"+
                        " <td>"+json.data[i].roleName+"</td>" +
                        " <td>"+json.data[i].description+"</td></tr>";
                    ids[i] = json.data[i].roleId;
                    /*console.log(ids[i]);
                    console.log("aaaa");*/
                }
                $('#permission').html(str);
            },error:function () {
                alert("flase");
            }
        });
        var modal = $(this);
        recipient = button.data('whatever') // 解析出data-whatever内容
        $.ajax({
            url:"/role/findRoleBegin",
            type: "POST",
            dataType: "json",
            data:{userId:recipient},
            success:function (json) {
             /*   console.log(recipient);
                console.log(json.data[1].roldId);
                console.log(json.data[1].userId);*/
                for (var i=0;i<json.data.length;i++){
                     if (-1 !=ids.indexOf(json.data[i].roleId)){
                        /* console.log(json.data[i].roleId);*/
                         modal.find('#'+json.data[i].roleId).attr("checked","checked");
                     }
                }
            }
        })

        modal.find('.modal-title').text('菜单选择')
        // modal.find('[type="checkbox"]').attr("checked","checked");
    });
    var getDate = function(){
        $.ajax({
            url: "/role/findAllUser",
            type: "post",
            dateType: "json",
            success: function (json) {
                var str = "";
                /*console.log(json.data[1].userId);*/

                for (var i = 0; i < json.data.length; i++) {
                    // console.log(json.data[i].gmtModity);
                    // console.log(formatDate(json.data[i].gmtModity));
                    var date = "";
                    date = new Date(json.data[i].gmtModify);
                    /*console.log(date);
                    console.log("aaa");
                    console.log(json.data[i].gmtModify);*/
                    str += '<tr>'
                        + '<th>' + json.data[i].userId + '</th>'
                        + '<th>' + json.data[i].username + '</th>'
                        + '<th>' + json.data[i].roleName + '</th>'
                        + '<th>' + date.toLocaleString() + '</th>'
                        + "<th ><button type='button' class='btn btn-default' data-toggle='modal' data-target='#exampleModal'" +
                        "data-whatever='" + json.data[i].userId + "'>编辑</button>" +
                        "</th>"
                        + '</tr>'
                }
                $('#roleList').html(str);
            }
        })
    }
    $(document).ready(function () {
     getDate();
    });
    var validate = function (data) {
        if (data == null) {
            return "";
        }
        return data;
    }

    function updataDate  () {
        var ids = new Array();
        $("input:checkbox:checked").each(function () {
            ids.push($(this).val());
        });
       $.ajax({
           url:"/role/updateRole",
           type:"POST",
           dataType:"json",
           data:{ids:ids,id:recipient},
           success:function (json) {
               console.log(ids);
               console.log(recipient);
               alert("success")
               $("#exampleModal").modal("hide");
               getDate();
           },error:function () {
               alert("ssdfsdf")
               $("#exampleModal").modal("hide");
           }
       })
    }
</script>
</body>
</html>