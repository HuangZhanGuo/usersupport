<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.facebank.usersupport.mapper.usersupport.p2p.RepaymentMapper">

    <resultMap id="repaymentResultMap" type="com.facebank.usersupport.model.RepaymentModel">
        <result column="cred_fp_order_id" property="credOrderId"/>
        <result column="cred_user_id" property="credUserId"/>
        <result column="cred_plan_principal" property="credPlanPrincipal"/>
        <result column="cred_plan_interest" property="credPlanInterest"/>
        <result column="cred_plan_date" property="credPlanDate"/>
        <result column="red_local_Info" property="redLocalInfo"/>
        <result column="red_plan_amount" property="redPlanAmount"/>
        <result column="red_package_type" property="redPackageType"/>
        <result column="red_term_num" property="redTermNum"/>
        <result column="vip_rate" property="vipRate"/>
        <result column="vip_plan_amount" property="vipPlanAmount"/>
        <result column="vip_term_num" property="vipTermNum"/>
        <result column="pf_plan_amount" property="pfPlanAmount"/>
        <result column="pf_term_num" property="pfTermNum"/>
        <result column="pf_type" property="pfType"/>
    </resultMap>

    <select id="getRepaymentModelByRepaymentForm" parameterType="com.facebank.usersupport.dto.reqDto.RepaymentForm" resultMap="repaymentResultMap">
		SELECT
			cred.fp_order_id 'cred_fp_order_id' ,
			cred.user_id 'cred_user_id' ,
			cred.cred_plan_principal ,
			cred.cred_plan_interest ,
			cred.plan_date 'cred_plan_date' ,
			red.local_Info 'red_local_Info' ,
			red.red_plan_amount ,
			red.red_package_type ,
			red.term_num 'red_term_num' ,
			vip.rate 'vip_rate' ,
			vip.vip_plan_amount ,
			vip.term_num 'vip_term_num' ,
			pf_intere.pf_plan_amount ,
			pf_intere.term_num 'pf_term_num' ,
			pf_intere.type 'pf_type'
		FROM(
			SELECT
				sum(plan_principal) cred_plan_principal,
				sum(plan_interest) cred_plan_interest,
				plan_date ,
				fp_order_id ,
				user_id
			FROM
				fp_main.credit_repayment
			<where>
				<if test="userId != null and orderId != ''">
					user_id = #{userId}
				</if>
				<if test="orderId != null and orderId != ''">
					AND fp_order_id = #{orderId}
				</if>
				<if test="startTime != null and startTime != ''">
					AND plan_date &gt;= #{startTime}
				</if>
				<if test="endTime != null and endTime != ''">
					AND plan_date &lt;= #{endTime}
				</if>
			</where>
			GROUP BY fp_order_id,plan_date
		) AS cred
		LEFT JOIN(
			SELECT
				sum(a.plan_amount) red_plan_amount ,
				a.plan_date ,
				a.fp_order_id ,
				b.local_Info ,
				b.user_id ,
				b.red_package_type ,
				a.term_num
			FROM
				fp_main.red_package_repayment AS a ,
				fp_main.red_package_rec AS b
			<where>
				a.fp_order_id = b.fp_order_id
				<if test="userId != null and orderId != ''">
					AND a.user_id = #{userId}
				</if>
				<if test="orderId != null and orderId != ''">
					AND a.fp_order_id = #{orderId}
				</if>
				<if test="startTime != null and startTime != ''">
					AND a.plan_date &gt;= #{startTime}
				</if>
				<if test="endTime != null and endTime != ''">
					AND a.plan_date &lt;= #{endTime}
				</if>
			</where>
			GROUP BY a.fp_order_id,a.plan_date
		) AS red ON cred.fp_order_id = red.fp_order_id and cred.plan_date=red.plan_date
		LEFT JOIN(
			SELECT
				a.fp_order_id ,
				a.user_id ,
				a.rate ,
				sum(b.plan_amount) vip_plan_amount ,
				b.plan_date ,
				b.term_num
			FROM
				fp_main.vip_interest_rec AS a ,
				fp_main.vip_interest_repayment AS b
			<where>
				a.fp_order_id = b.fp_order_id
				<if test="userId != null and orderId != ''">
					AND a.user_id = #{userId}
				</if>
				<if test="orderId != null and orderId != ''">
					AND a.fp_order_id = #{orderId}
				</if>
				<if test="startTime != null and startTime != ''">
					AND b.plan_date &gt;= #{startTime}
				</if>
				<if test="endTime != null and endTime != ''">
					AND b.plan_date &lt;= #{endTime}
				</if>
			</where>
			GROUP BY a.fp_order_id,b.plan_date
		) AS vip ON cred.fp_order_id = vip.fp_order_id and cred.plan_date = vip.plan_date
		LEFT JOIN(
			SELECT
				a.invest_id fp_order_id,
				b.type ,
				b.invest_user user_id,
				b.plan_date ,
				b.term_num ,
				sum(b.plan_amount) pf_plan_amount
			FROM
				pf_interest.record AS a ,
				pf_interest.repayment AS b
			<where>
				a.record_id = b.record_id
				<if test="userId != null and orderId != ''">
					AND a.invest_user = #{userId}
				</if>
				<if test="orderId != null and orderId != ''">
					AND a.invest_id = #{orderId}
				</if>
				<if test="startTime != null and startTime != ''">
					AND b.plan_date &gt;= #{startTime}
				</if>
				<if test="endTime != null and endTime != ''">
					AND b.plan_date &lt;= #{endTime}
				</if>
			</where>
			GROUP BY a.invest_id,b.plan_date
		) AS pf_intere ON cred.fp_order_id = pf_intere.fp_order_id and cred.plan_date = pf_intere.plan_date
		ORDER BY cred.plan_date DESC
    </select>

</mapper>